!function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);let n=$smcT5,s=($smcJQ,n.CookieManager),o=n.tagHelpers,r=n.outputs,a=o.DBC,c=o.DBW,d=(o.DBE,o.getURL()),u=o.get,l=o.referrerDomain,h=o.functionizer,v=o.ajax.post,p=void 0===window.$smcDebugger?0:1,f=r.smarterCodes.endpoint,g=r.smarterCodes.campaign_id;var y=n;function m(e,t){return this.options={seconds:.5,decay:1.4,max:10,callback:e},this.options={...this.options,...t},this.timer=this.options.seconds,this.timeout=null,this.running=void 0,this.expired=void 0,this}m.prototype.start=function(){(this.running||void 0===this.running)&&(this.running=!0),this.cycle()},m.prototype.reset=function(){this.timer=this.options.seconds,this.start()},m.prototype.cycle=function(){if(this.running){if(this.timer>this.options.max)return this.stop(),this.expired=!0,void this.options.callback.apply(this);clearTimeout(this.timeout);var e=this;this.timeout=setTimeout(function(){e.options.callback.apply(e),e.cycle.apply(e)},1e3*this.timer),this.timer=this.timer*this.options.decay}},m.prototype.stop=function(){this.running&&(this.running=!1)};var k=m;let C="SMC VCC: ";function b(e,t,i){let n=t=>[].forEach.call(e,function(e){e.addEventListener(t,i,!1)});return Array.isArray(t)?t.forEach(e=>n(e)):n(t)}let S=!1;var x=function(e,t,i,n,s){if(!e||"String"!==e.constructor.name)throw new Error("Code requires a valid string to create an instance");if(S||(S=N.config),this.code=e||"",this.origin=t||void 0,this.valid=void 0!==i?i:void 0,this.dataSent=void 0!==n&&n,this.message=void 0!==s?s:"",this.activeCheck=!1,this.status={key:void 0,name:void 0},this.basket=this.delivery=this.sums={value:0,discount:0,percent:0},void 0!==this.valid)return this;var o=S.validCheck;if(o.trigger)if("pageLoad"===o.trigger.event)a(C,`Not checking code '${this.code}' immediately, setting page load trigger`),"cookie"===t&&this.check();else{let e=o.trigger;a(C,`Not checking code '${this.code}' immediately, setting custom trigger ${e.event} on ${e.selector}`),document.querySelector(e.selector).addEventListener(e.event,this.check)}else this.check()};x.prototype.check=function(){if(a(C,"Checking if code is valid..."),void 0!==this.valid)return!1;var e=this,t=S.validCheck?S.validCheck:{},i=S.invalidCheck?S.invalidCheck:{};let n;var s=function(){};t.method&&""!==t.selector&&i.method&&""!==i.selector?s=function(){a(C,"check..."),e.activeCheck.expired?c():d(i)?r(!1):d(t)&&r(!0)}:(n=t.method&&""!==t.selector?t:i,s=function(){e.activeCheck.expired?c():d(n)&&r(!0)});var o=S.decay?S.decay:{seconds:.5,decay:1.4,max:10};function r(t){e.valid=t,e.updateValues(),e.updateStatus(t),e.activeCheck.stop(),e.sendData(),e.dataSent=!0,N.updateCookie(),a(C,t?"Valid":"Invalid condition found. Checks stopped")}function c(){a(C,"The Decay check has expired, defaulting to: ",S.validCheck.default),void 0!==S.validCheck.default&&r(S.validCheck.default)}function d(e){var t=document.querySelector(e.selector);switch(e.method){case"elementExists":return t.length>0;case"elementVisible":return function(){if(!(t&&t instanceof HTMLElement))return!1;var e=window.getComputedStyle(t);return!("none"===e.display||"hidden"===e.visibility)}();case"elementAttribute":return t.getAttribute(e.attribute)===e.attributeValue;case"elementClass":return!!t.classList.contains(e.class)}}this.activeCheck=new k(s,o),this.activeCheck.start()},x.prototype.collectData=function(){a(C,"Collecting data on code");let e="{}",t=s.read("smct_sources");t?e=atob(t):a(C,"smct_sources cookie does not exist - may cause missing data");let i=l();return{sources:e,domain_referrer_id:i,meta:{values:{basket:{value:this.basket.value,discount:this.basket.discount,percentage:this.basket.percent},delivery:{value:this.delivery.value,discount:this.delivery.discount,percentage:this.delivery.percent},total:{value:this.sums.value,discount:this.sums.discount,percentage:this.sums.percent}}},user_id:u("uid"),tag_index:u("id"),device_id:u("dv").id,code:this.code,success:this.valid?1:0,message:this.message,debug:p,status_key:this.status.key}},x.prototype.updateValues=function(){a(C,"Updating values");var e=this,t=this.valid?S.validCheck:S.invalidCheck;t=t||{};var i={value:0,discount:0,percent:0};function n(t){var i,n=0,o=0;return i=t.value?s(t.value,!0):0,e.valid&&(n=t.discount?s(t.discount,!0):0,o=t.percent?s(t.percent,!0):0),function(e,t,i,n=!1){let s={value:e,discount:t,percent:i};if(e>0&&(0!==t||0!==i)){if(0===t){let s;n?(s=e,e*=1+i/100):s=e-e*(i/100),t=e-s}else 0===i&&(i=t/(e=n?e+t:e)*100);s={value:e,discount:t,percent:i},Object.keys(s).forEach(e=>s[e]=Math.round(100*s[e])/100)}return s}(i,n,o)}function s(e,t){var i=document.querySelector(e.selector);if(!i)return t?0:"";switch(e.type){case"text":return t?o(i.innerText):i.innerText;case"html":return t?o(i.innerHTML):i.innerHTML;case"attribute":return t?o(i.getAttribute(e.attrName)):i.getAttribute(e.attrName);case"textNoChild":return t?o(r(i)):r(i)}}function o(e){var t=h(e,[{type:"special",vals:[]}]);return null===t||""===t?0:t}function r(e){let t=e.firstChild,i=[];for(;t;)3===t.nodeType&&i.push(t.data),t=t.nextSibling;return i.join("")}this.message=t.message?s(t.message):"",this.basket=S.basket?n(S.basket):i,this.delivery=S.delivery?n(S.delivery):i,this.message=this.message?this.message.trim():"",this.sums=function(){var t=e.basket.value+e.delivery.value,i=e.basket.discount+e.delivery.discount;let n=i/t*100;return n=n?Math.round(100*n)/100:0,{value:t,discount:i,percent:n}}()},x.prototype.sendData=function(){if(this.dataSent)return a(C,"Code.sendData(): Data already sent. Will not send twice."),!1;this.dataSent=!0,a(C,"Posting results to the back end \nCode: "+this.code+"\nValid Code: "+this.valid);let e=JSON.stringify(this.collectData());if(e={d:p?e:btoa(e)},p){let e={value:{basket:this.basket.value,delivery:this.delivery.value,sum:this.sums.value},discount:{basket:this.basket.discount,delivery:this.delivery.discount,sum:this.sums.discount},percent:{basket:this.basket.percent,delivery:this.delivery.percent,sum:this.sums.percent}};c(C,"\nCode: ",this.code,"\nResult:",this.valid?"valid":"invalid",""),console.table(e)}v(f+"?handle=code-store",e,function(e){if(p&&e)try{e=JSON.parse(e),a(C," smcdz-ep res: ",e)}catch(t){a(C,"smcdz-ep res, JSON.parse fail: ",e)}})},x.prototype.stringify=function(){return a(C,"Stringify data of code object"),JSON.stringify({code:this.code,valid:this.valid,dataSent:this.dataSent,message:this.message})},x.prototype.updateStatus=function(e){return e?(this.basket.discount>0&&this.delivery.discount>0?this.status={name:"valid basket delivery",key:1}:this.basket.discount>0?this.status={name:"valid basket",key:2}:this.delivery.discount>0?this.status={name:"valid delivery",key:3}:0===this.delivery.discount&&0===this.basket.discount?this.status={name:"valid",key:4}:this.status={name:"uncaught",key:null},!0):(this.status={name:"invalid",key:0},!1)};var w=x,I=function(){return this.readHistory=function(){a(C,"Reading code history of user");var e=s.read("smc_vcc_history");return null===e?[]:e.split(",,").map(function(e){try{let t=JSON.parse(e);return new w(t.code,"cookie",t.valid,t.dataSent,t.message)}catch(e){return void(p&&c(C,"Failed to parse existing Codes from cookie: ",e))}})},this.updateConfig=function(){let e=this;v(f+"?handle=campaign",{cid:g},function(t){try{t=JSON.parse(t)}catch(e){return void(p&&c(C,"Config parse failure: ",e,t))}if(a(C,"config res:",t),1==t.r)if(1==t.setup.active){if(e.config=function(e){return{url:e.url&&""!==e.url?e.url:void 0,checkForInput:"1"===e.checkForInput,codeInput:(i=e.codeInput,"string"==typeof i?i:"invalid_selector"),decay:function(e){let t=e.seconds?parseFloat(e.seconds):NaN,i=e.decay?parseFloat(e.decay):NaN,n=e.max?parseFloat(e.max):NaN;return{seconds:!isNaN(t)&&t>0?t:.5,decay:!isNaN(i)&&i>1?i:1.4,max:!isNaN(n)&&n>0?n:10}}(e.decay),newCode:(t=e.newCode,{enterKey:"1"===t.enterKey,method:"string"==typeof t.method?t.method:"elementVisible",selector:"string"==typeof t.selector?t.selector:""}),validCheck:""!==e.validCheck.selector||"undefined"!==e.validCheck.trigger.event?n(e.validCheck):void 0,invalidCheck:""!==e.invalidCheck.selector||"undefined"!==e.invalidCheck.trigger.event?n(e.invalidCheck):void 0,basket:s(e.basket),delivery:s(e.delivery)};var t,i;function n(e){return{...e,default:"0"!==e.default&&("1"===e.default||void 0),message:"undefined"===e.message.type?void 0:e.message,trigger:"undefined"===e.trigger.event?void 0:e.trigger}}function s(e){return"undefined"!==e.value.type&&(e.value.includesDiscount="1"===e.value.includesDiscount),{value:"undefined"!==e.value.type?e.value:void 0,discount:"undefined"!==e.discount.type?e.discount:void 0,percent:"undefined"!==e.percent.type?e.percent:void 0}}}(t.setup.campaign_data.dom_setup),a(C,"Smarter Codes is running. URL to match:",e.config.url,d.match(e.config.url)),void 0!==e.config.url&&null===d.match(e.config.url))return a(C,"Config URL is defined but does not match current URL"),!1;e.setupCodeTrigger()}else a(C,"Smarter Codes is Off");else c(C,"Smarter Codes - Not Loaded: ",t.msg||t.errors)})},this.updateConfig(),this.setupCodeInput=function(e){var t=this;let i=e=>(b(e,["keydown","paste","cut","change"],function(e){t.activeCodeInput!==e.target&&(t.activeCodeInput=e.target)}),e);if(!this.config.checkForInput)return t.codeInput=document.querySelectorAll(t.config.codeInput),t.activeCodeInput=t.codeInput[0],i(t.codeInput),e(),t.codeInput;var n,s=new k(function(){(n=document.querySelectorAll(t.config.codeInput)).length>0&&(s.stop(),t.codeInput=n,t.activeCodeInput=t.codeInput[0],i(t.codeInput),e())},{seconds:.1,decay:1.05,max:100});s.start()},this.setupCodeTrigger=function(){var e=this;function t(t){let i=e.activeCodeInput.value;if(!(""===i||i.indexOf(",,")>-1)){var n=function(e,t){return new w(e,t)}(i,t.target);a(C,"smcCodeCreateTrigger(): New code created: ",n),e.checkCodeHistory(n)?n.activeCheck&&n.activeCheck.running&&(n.activeCheck.stop(),a(C,"Code already exists in user history. No need to add to history.",n)):e.addToHistory(n)}}this.setupCodeInput(function(){a(C,"Creating new code triggers");var i=e.config.newCode;switch(i.method){case"buttonClick":!function(e){let i=document.querySelectorAll(e);a(C,"Setting up button click trigger on: ",i||"document"),i&&document.addEventListener("click",function(n){n.target&&([].indexOf.call(i,n.target)>-1||n.target.matches(` ${e}, ${e} * `))&&t(n)})}(i.selector);break;case"inputChange":b(e.codeInput,"change",t)}a(C,"trigger.enterKey = ",i.enterKey),i.enterKey&&(a(C,"Setting up enter key trigger on: ",e.codeInput),b(e.codeInput,"keydown",function(i){i.target!==e.activeCodeInput&&(e.activeCodeInput=i.target),13===i.keyCode&&t(i)})),e.codeHistory=e.readHistory()})},this.checkCodeHistory=function(e){if(!(e instanceof w))throw new Error("User can only check Code objects against history");a(C,"Checking if code exists in history");var t=!1;return this.codeHistory.forEach(function(i){i.code===e.code&&(t=!0)}),t},this.updateCookie=function(){var e=this.codeHistory.map(function(e){return e.stringify()});s.create("smc_vcc_history",e.join(",,"))},this.addToHistory=function(e){if(!(e instanceof w))throw new Error("User can only add Code objects to history");a(C,"Adding code to user history"),this.codeHistory.push(e),this.updateCookie()},this};y.vcc="User instance not yet created. Ensure input can be found on page, then User will be created.",y.vcc=new I;var N=t.default=y.vcc}]);
